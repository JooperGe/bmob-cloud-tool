var fs = require("fs");
var path = require("path");
var Buffer = require('buffer').Buffer;
var UglifyJS = require("uglify-js");
var promptly = require('promptly');
var program = require('commander');

var common = require("./../bmob-cloud-common.js");
var Bmob = common.Bmob;

var cloud = require("./../lib/bmob-cloud-functions.js");

var pkg = require('./../package.json'),
    version = pkg.version;
program
    .version(version)
    .usage("[options] <cmd> <file_or_directory> \n\n" +
        "Valid commands: \n" +
        "\tpublish: 发布开发环境代码到生产环境\n" +
        "file_or_directory: 导入（目录下）文件中的方法到云端，默认basedir路径下的cloud文件夹")
    .option('--basedir [path]', '本地云代码项目根路径，默认是当前目录')
    .option('--appkey <appkey>', 'Bmob ApplicationId')
    .option('--restkey <restkey>', 'Bmob RestKey')
;

program.parse(process.argv);

var appkey = program.appkey,
    restkey = program.restkey,
    basedir = program.basedir || "./";

var cmd = program.args.shift(),
    file = program.args.shift() || "cloud";

function publish_one(file) {
    var codeAll = fs.readFileSync(file, "utf8");

    var ast = UglifyJS.parse(codeAll);

    var code = ast.body[0].print_to_string({ beautify: true });
    var name = ast.body[ast.body.length-1].body.left.property;

    var pcode = new Buffer(code).toString('base64')
    cloud.update({"name": name, "data": {"code": pcode} }, function (err, resp) {
        console.log(resp);
    })
}

function publish() {
    Bmob.initialize(appkey, restkey);
    console.log('Publishing cloud code to production...');

//    path.normalize('/foo/bar//baz/asdf/quux/..')
//    path.join([path1], [path2], [...])

    var cloudPath = path.resolve(basedir, file);
    var cloudStat = fs.statSync(cloudPath);
    if (cloudStat.isFile()) {
        publish_one(cloudPath);
    } else {
        fs.readdirSync(cloudPath).forEach(
            function (name) {
                var subPath = path.join(cloudPath, name);
                var subStat = fs.statSync(subPath);
                if (stat.isFile()) {
                    publish_one(subPath);
                }
            }
        );
    }

}

// node bmob --appkey 4414150cb439afdf684d37dc184e0f9f --restkey e1deb317442129c125b228ddf78e5f22 --basedir "../" publish test/hello.js

switch (cmd) {
    case "publish":
        publish();
        break;
    default:
        program.help();
        break;
}