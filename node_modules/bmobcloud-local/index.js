var __modules = {}

__modules.oData = require("./lib/bmob-cloud-data.js");

__modules.oPush = require("./lib/bmob-cloud-push.js");
__modules.oRelation = require("./lib/bmob-cloud-relation.js");
__modules.oFile = require("./lib/bmob-cloud-file.js");
__modules.oFunctions = require("./lib/bmob-cloud-functions.js");
__modules.oAtom = require("./lib/bmob-cloud-atom.js");
__modules.oBatch = require("./lib/bmob-cloud-batch.js");
__modules.oArray = require("./lib/bmob-cloud-array.js");
__modules.oLocation = require("./lib/bmob-cloud-location.js");

__modules.oAsync = require("./lib/bmob-cloud-async.js");
__modules.oEncodeing = require("./lib/bmob-cloud-encoding.js");
__modules.oEvent = require("./lib/bmob-cloud-event.js");
__modules.oHtmlparser = require("./lib/bmob-cloud-htmlparser.js");
__modules.oHttp = require("./lib/bmob-cloud-http.js");
__modules.oMail = require("./lib/bmob-cloud-mail.js");

var common = require("./bmob-cloud-common.js");
var Bmob = __modules.Bmob = common.Bmob;

var Response = function (done) {
    var model = {};
    model.end = function (data) {
        console.log(data);
        done && done();
    }

    return model;
}

var Request = function (param) {
    var model = {};
    model.body = param;

    return model;
}

var model = {};

model.initialize = function (app_key, rest_key) {
    Bmob.initialize(app_key, rest_key);
}

var testOld = model.testOld = function (onRequest, reqeustParam, responseCallback) {
    onRequest(new Request(reqeustParam || {}), new Response(responseCallback), __modules);
}

// just support exports one!!!
model.test = function (file, requestParam, responseCallback) {
    if (typeof file == "function") {
        var one = file;
        testOld(one, requestParam, responseCallback);
    } else {
        var group = require(file);
        var name;
        for (one in group) {
            name = one;
        }

//            console.log(group[name].toString());
        group[name](new Request(reqeustParam || {}), new Response(responseCallback), __modules);
    }
}

model.testInServer = function (file, requestParam, responseCallback) {
    var code = require(file);
    var name;
    for (one in code) {
        name = one;
    }

    if (name) {
        var run = function () {
            __modules.oFunctions.run(
                {"name": name, "data": requestParam || {}},
                function (err, resp) {
                    console.log(resp || err);
                    if (resp) {
                        responseCallback && responseCallback(resp);
                    }
                }
            );
        }

        var pub = require("./pub.js");
        pub(file, run);
    }
}

module.exports = model;
